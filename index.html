<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Earth Explorer</title>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.122/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.122/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Instrument+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a0a;font-family:'Instrument Sans',sans-serif}
#cesiumContainer{width:100%;height:100%;position:absolute;top:0;left:0}
.cesium-viewer-bottom{display:none!important}
.cesium-viewer-fullscreenContainer,.cesium-viewer-toolbar,
.cesium-performanceDisplay-defaultContainer{display:none!important}
.cesium-widget-credits{display:none!important}
.cesium-credit-logoContainer{display:none!important}
.cesium-credit-textContainer{display:none!important}
.cesium-credit-expand-link{display:none!important}

#tokenScreen{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(160deg,#0a0a0a 0%,#111 50%,#0d1117 100%)}
.token-card{width:460px;padding:48px;border-radius:20px;
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 40px 80px rgba(0,0,0,0.5)}
.token-card h1{font-size:28px;font-weight:700;color:#f0f0f0;margin-bottom:6px;letter-spacing:-0.5px}
.token-card .subtitle{font-size:13px;color:rgba(255,255,255,0.4);margin-bottom:28px;line-height:1.6}
.token-card label{display:block;font-size:11px;font-weight:600;color:rgba(255,255,255,0.5);
  text-transform:uppercase;letter-spacing:1.2px;margin-bottom:8px}
.token-card input{width:100%;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.04);color:#e0e0e0;font-size:14px;font-family:'DM Mono',monospace;
  outline:none;transition:border-color .2s}
.token-card input:focus{border-color:rgba(255,255,255,0.2)}
.token-card input::placeholder{color:rgba(255,255,255,0.2)}
.token-field{margin-bottom:20px}
.token-card button{width:100%;padding:14px;border-radius:12px;border:none;
  background:#fff;color:#0a0a0a;font-size:15px;font-weight:700;cursor:pointer;
  transition:all .15s;margin-top:8px;font-family:'Instrument Sans',sans-serif}
.token-card button:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(255,255,255,0.1)}
.token-error{color:#ff6b6b;font-size:12px;margin-top:12px;display:none;line-height:1.5}
.token-link{color:rgba(255,255,255,0.5);font-size:12px;text-decoration:none;
  border-bottom:1px solid rgba(255,255,255,0.15);transition:color .2s}
.token-link:hover{color:rgba(255,255,255,0.8)}
.token-note{font-size:11px;color:rgba(255,255,255,0.25);margin-top:4px;line-height:1.4}

#loadingOverlay{position:fixed;inset:0;z-index:8000;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);flex-direction:column;gap:20px}
#loadingOverlay.active{display:flex}
.loading-spinner{width:32px;height:32px;border:2px solid rgba(255,255,255,0.1);
  border-top-color:rgba(255,255,255,0.6);border-radius:50%;animation:spin .8s linear infinite}
.loading-text{color:rgba(255,255,255,0.6);font-size:14px;font-weight:500}
@keyframes spin{to{transform:rotate(360deg)}}

#hud{position:fixed;bottom:24px;left:24px;z-index:100;pointer-events:none;
  display:none;opacity:0;transition:opacity .4s}
#hud.visible{display:block;opacity:1}
.hud-panel{background:rgba(0,0,0,0.55);backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:16px 22px;min-width:200px}
.hud-speed{font-family:'DM Mono',monospace;font-size:42px;font-weight:500;
  color:#f0f0f0;line-height:1;letter-spacing:-2px}
.hud-speed-unit{font-size:13px;color:rgba(255,255,255,0.35);margin-left:4px;font-weight:400;letter-spacing:0}
.hud-row{display:flex;gap:24px;margin-top:12px}
.hud-stat{display:flex;flex-direction:column;gap:2px}
.hud-label{font-size:10px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.hud-value{font-family:'DM Mono',monospace;font-size:15px;color:rgba(255,255,255,0.7)}

.hud-vehicle-badge{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:100;
  display:none;opacity:0;transition:opacity .4s;pointer-events:all;cursor:pointer}
.hud-vehicle-badge.visible{display:flex;opacity:1}
.badge-inner{background:rgba(0,0,0,0.45);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,0.06);border-radius:10px;
  padding:10px 22px;font-size:24px;color:#fff;
  font-weight:600;letter-spacing:2px;display:flex;align-items:center;gap:6px}
.badge-eye{background:rgba(0,0,0,0.45);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,0.06);border-radius:10px;
  padding:6px 16px;font-size:18px;cursor:pointer;margin-top:6px;
  display:inline-block;transition:all .15s;text-align:center}
.badge-eye:hover{border-color:rgba(255,255,255,0.15)}

#controlsHelp{position:fixed;bottom:24px;right:24px;z-index:100;display:none;opacity:0;transition:opacity .4s}
#controlsHelp.visible{display:block;opacity:1}
#topLeftBar{position:fixed;top:20px;left:24px;z-index:100;display:none;opacity:0;transition:opacity .4s;pointer-events:all;flex-direction:row;align-items:flex-start;gap:8px}
#topLeftBar.visible{display:flex;opacity:1}
.gps-inner{background:rgba(0,0,0,0.55);backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:10px 16px;
  cursor:pointer;transition:all .15s;user-select:none}
.gps-inner:hover{border-color:rgba(255,255,255,0.15)}
.gps-inner:active{transform:scale(0.97)}
.gps-label{font-size:9px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;
  font-weight:600;margin-bottom:4px}
.gps-value{font-family:'DM Mono',monospace;font-size:13px;color:rgba(255,255,255,0.7);line-height:1.4}
.gps-copied{font-size:10px;color:rgba(100,255,150,0.7);margin-top:4px;opacity:0;transition:opacity .2s}
.gps-copied.show{opacity:1}
.controls-toggle{background:rgba(0,0,0,0.45);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,0.06);border-radius:10px;
  padding:8px 14px;font-size:12px;color:rgba(255,255,255,0.55);cursor:pointer;
  pointer-events:all;transition:all .15s;font-family:'Instrument Sans',sans-serif}
.controls-toggle:hover{color:rgba(255,255,255,0.8);border-color:rgba(255,255,255,0.12)}
.controls-panel{background:rgba(0,0,0,0.65);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,0.06);border-radius:14px;
  padding:20px 24px;margin-bottom:10px;display:none;min-width:240px;pointer-events:all}
.controls-panel.open{display:block}
.controls-panel h3{font-size:11px;color:rgba(255,255,255,0.35);text-transform:uppercase;
  letter-spacing:1.5px;margin-bottom:14px;font-weight:600}
.control-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0}
.control-key{font-family:'DM Mono',monospace;font-size:12px;color:rgba(255,255,255,0.6);
  background:rgba(255,255,255,0.06);padding:2px 8px;border-radius:4px}
.control-action{font-size:12px;color:rgba(255,255,255,0.35)}

#crashScreen{position:fixed;inset:0;z-index:200;display:none;align-items:center;
  justify-content:center;flex-direction:column;gap:16px;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(8px)}
#crashScreen.active{display:flex}
.crash-title{font-size:48px;font-weight:700;color:#ff4444;letter-spacing:-1px}
.crash-sub{font-size:14px;color:rgba(255,255,255,0.4)}
.crash-btn{padding:12px 32px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);
  background:rgba(255,255,255,0.05);color:#f0f0f0;font-size:14px;font-weight:600;
  cursor:pointer;transition:all .15s;font-family:'Instrument Sans',sans-serif;margin-top:8px}
.crash-btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.25)}

#locationSelector{position:fixed;top:20px;right:24px;z-index:100;display:none;opacity:0;transition:opacity .4s}
#locationSelector.visible{display:block;opacity:1}
.loc-btn{background:rgba(0,0,0,0.45);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,0.06);border-radius:10px;
  padding:8px 14px;font-size:12px;color:rgba(255,255,255,0.55);cursor:pointer;
  pointer-events:all;transition:all .15s;font-family:'Instrument Sans',sans-serif}
.loc-btn:hover{color:rgba(255,255,255,0.8);border-color:rgba(255,255,255,0.12)}
.loc-panel{background:rgba(0,0,0,0.65);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,0.06);border-radius:14px;
  padding:16px 20px;margin-top:10px;display:none;min-width:200px;pointer-events:all;
  max-height:70vh;overflow-y:auto}
.loc-panel.open{display:block}
.loc-item{padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;
  color:rgba(255,255,255,0.5);transition:all .12s;display:flex;align-items:center;gap:10px}
.loc-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.85)}
.loc-icon{font-size:16px;width:24px;text-align:center}
</style>
</head>
<body>
<div id="tokenScreen">
  <div class="token-card">
    <h1 style="text-align:center">üöÅ Earth Explorer üöó</h1>
    <div class="subtitle" style="text-align:center">By: <a href="https://understory.media" target="_blank" class="token-link" style="font-size:inherit">Sepehr Samimi</a> x <a href="https://www.sunsetvisitor.studio" target="_blank" class="token-link" style="font-size:inherit">SunsetVisitor</a></div>
    <div class="token-field">
      <label>Cesium Ion Token</label>
      <input type="text" id="cesiumTokenInput" placeholder="eyJhbGciOiJIUzI1NiIs..." autocomplete="off">
    </div>
    <button id="tokenSubmit" onclick="submitToken()">Launch</button>
    <div style="text-align:center;color:rgba(255,255,255,0.2);font-size:11px;margin-top:10px;letter-spacing:0.5px">V1.1 ‚Äî Feb 2026</div>
    <div id="countdownText" style="text-align:center;color:rgba(255,255,255,0.4);font-size:13px;margin-top:14px;font-variant-numeric:tabular-nums;">Auto-launching in <span id="countdownNum">5</span>s...</div>
    <div class="token-error" id="tokenError"></div>
  </div>
</div>

<div id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">Initializing...</div>
</div>

<div id="cesiumContainer"></div>

<div id="hud">
  <div class="hud-panel">
    <div><span class="hud-speed" id="hudSpeed">0</span><span class="hud-speed-unit">m/s</span></div>
    <div class="hud-row">
      <div class="hud-stat"><span class="hud-label">Alt</span><span class="hud-value" id="hudAlt">0 m</span></div>
      <div class="hud-stat"><span class="hud-label">Hdg</span><span class="hud-value" id="hudHdg">0¬∞</span></div>
      <div class="hud-stat"><span class="hud-label">Camera</span><span class="hud-value" id="hudCam">Follow</span></div>
    </div>
  </div>
</div>

<div class="hud-vehicle-badge" id="vehicleBadge" style="display:flex;flex-direction:column;align-items:center">
  <div class="badge-inner" onclick="toggleVeh()"><span id="badgeDrone">üöÅ</span> <span style="font-size:14px;opacity:0.8">‚áÑ</span> <span id="badgeCar" style="opacity:0.8">üöó</span></div>
  <div class="badge-eye" onclick="toggleModelVis()" id="eyeToggle" title="Hide/Show Model (V)" style="font-size:14px;opacity:0.8">üëÅ</div>
</div>

<div id="topLeftBar">
  <div id="gpsPanel" onclick="copyGPS()">
    <div class="gps-inner">
      <div class="gps-label">Coordinates ‚Äî click to copy</div>
      <div class="gps-value" id="gpsText">0.00000, 0.00000</div>
      <div class="gps-copied" id="gpsCopied">‚úì Copied to clipboard</div>
    </div>
  </div>
  <div id="screenshotBtn">
    <button class="controls-toggle" onclick="takeScreenshot()" title="Screenshot (P)" style="padding:10px 14px;color:#fff">üì∑</button>
  </div>
</div>

<div id="locationSelector">
  <button class="loc-btn" onclick="toggleLocPanel()">üìç Teleport</button>
  <div class="loc-panel" id="locPanel"></div>
</div>

<div id="flashOverlay" style="position:fixed;inset:0;z-index:9000;background:white;opacity:0;pointer-events:none;transition:opacity 0.08s"></div>

<div id="controlsHelp">
  <div class="controls-panel" id="ctrlPanel">
    <h3>Controls</h3>
    <div class="control-row"><span class="control-action">Throttle</span><span class="control-key">W</span></div>
    <div class="control-row"><span class="control-action">Brake</span><span class="control-key">S</span></div>
    <div class="control-row"><span class="control-action">Turn</span><span class="control-key">A D</span></div>
    <div class="control-row"><span class="control-action">Climb / Dive</span><span class="control-key">‚Üë ‚Üì</span></div>
    <div class="control-row"><span class="control-action">Roll</span><span class="control-key">Q E</span></div>
    <div class="control-row"><span class="control-action">Camera</span><span class="control-key">C</span></div>
    <div class="control-row"><span class="control-action">Change Vehicle</span><span class="control-key">M</span></div>
    <div class="control-row"><span class="control-action">Restart</span><span class="control-key">R</span></div>
    <div class="control-row"><span class="control-action">Hide Model</span><span class="control-key">V</span></div>
    <div class="control-row"><span class="control-action">Screenshot</span><span class="control-key">P</span></div>
    <div class="control-row"><span class="control-action">Look Around</span><span class="control-key">üñ± Drag</span></div>
    <div class="control-row"><span class="control-action">Zoom</span><span class="control-key">üñ± Scroll</span></div>
  </div>
  <button class="controls-toggle" onclick="toggleCtrlPanel()">Controls</button>
</div>

<div id="crashScreen">
  <div class="crash-title">CRASHED</div>
  <div class="crash-sub">Your aircraft hit the terrain</div>
  <button class="crash-btn" onclick="restart()">Press R or click to restart</button>
</div>

<script>
const SK_C='flightsim_cesium_token';

const DEFAULT_TOKEN='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI2NTQ5ZDBmZi0zOGRjLTQzOTAtYTUxMS1lNjlhNjY3MzU4OWIiLCJpZCI6MzkzNDg5LCJpYXQiOjE3NzE4ODM3NTd9.xf_hhpNf1p0rfJh3wo82irHmj_gBJvYod06QDJ0w2Bk';
let _countdownId=null,_countdownVal=5;
(function(){
  const c=localStorage.getItem(SK_C)||DEFAULT_TOKEN;
  if(c)document.getElementById('cesiumTokenInput').value=c;
  // Start auto-launch countdown
  startCountdown();
  // Cancel countdown when user interacts with input
  document.getElementById('cesiumTokenInput').addEventListener('focus',cancelCountdown);
  document.getElementById('cesiumTokenInput').addEventListener('click',cancelCountdown);
  document.getElementById('cesiumTokenInput').addEventListener('input',cancelCountdown);
})();

function startCountdown(){
  _countdownVal=5;
  const numEl=document.getElementById('countdownNum');
  const txtEl=document.getElementById('countdownText');
  numEl.textContent=_countdownVal;
  txtEl.style.display='block';
  _countdownId=setInterval(()=>{
    _countdownVal--;
    if(_countdownVal<=0){
      clearInterval(_countdownId);_countdownId=null;
      txtEl.textContent='Launching...';
      submitToken();
    }else{
      numEl.textContent=_countdownVal;
    }
  },1000);
}

function cancelCountdown(){
  if(_countdownId){clearInterval(_countdownId);_countdownId=null;}
  const txtEl=document.getElementById('countdownText');
  txtEl.style.display='none';
}

function submitToken(){
  cancelCountdown();
  const ct=document.getElementById('cesiumTokenInput').value.trim()||DEFAULT_TOKEN;
  if(ct)localStorage.setItem(SK_C,ct);
  document.getElementById('tokenScreen').style.display='none';
  document.getElementById('loadingOverlay').classList.add('active');
  setLT('Initializing Cesium...');
  initGame(ct,'');
}
function showErr(m){const e=document.getElementById('tokenError');e.textContent=m;e.style.display='block';}
function setLT(t){document.getElementById('loadingText').textContent=t;}
function backToToken(m){
  document.getElementById('loadingOverlay').classList.remove('active');
  document.getElementById('tokenScreen').style.display='flex';
  if(m)showErr(m);
}

// ‚îÄ‚îÄ‚îÄ LOCATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LOCS=[
  {name:'Thunder Bay',icon:'üá®üá¶',lng:-89.2477,lat:48.3809,alt:300,hdg:180},
  {name:'Vancouver',icon:'üá®üá¶',lng:-123.1216,lat:49.2827,alt:300,hdg:180},
  {name:'Hong Kong',icon:'üá≠üá∞',lng:114.1694,lat:22.3193,alt:350,hdg:180},
  {name:'Tehran',icon:'üáÆüá∑',lng:51.3890,lat:35.6892,alt:350,hdg:0},
  {name:'New York',icon:'üóΩ',lng:-74.006,lat:40.7128,alt:350,hdg:45},
  {name:'San Francisco',icon:'üåâ',lng:-122.4194,lat:37.7749,alt:300,hdg:0},
  {name:'London',icon:'üá¨üáß',lng:-0.1276,lat:51.5074,alt:250,hdg:90},
  {name:'Tokyo',icon:'üóº',lng:139.6917,lat:35.6895,alt:300,hdg:180},
  {name:'Singapore',icon:'üá∏üá¨',lng:103.8198,lat:1.3521,alt:300,hdg:0},
  {name:'Dubai',icon:'üèôÔ∏è',lng:55.2708,lat:25.2048,alt:400,hdg:0},
  {name:'Paris',icon:'üá´üá∑',lng:2.2945,lat:48.8584,alt:250,hdg:0},
  {name:'Grand Canyon',icon:'üèúÔ∏è',lng:-112.1129,lat:36.0544,alt:500,hdg:90},
  {name:'Rome',icon:'üèõÔ∏è',lng:12.4964,lat:41.9028,alt:200,hdg:0},
  {name:'Rio de Janeiro',icon:'üáßüá∑',lng:-43.1729,lat:-22.9068,alt:350,hdg:180},
];
(function(){const p=document.getElementById('locPanel');
  // Add Enter Coordinates as first option
  const coordDiv=document.createElement('div');
  coordDiv.id='coordEntry';
  coordDiv.innerHTML=`
    <div class="loc-item" onclick="toggleCoordInput(event)" style="border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:10px;margin-bottom:6px">
      <span class="loc-icon">üìê</span>Enter Coordinates
    </div>
    <div id="coordInputArea" style="display:none;padding:6px 10px 10px">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <div style="flex:1">
          <div style="font-size:9px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Latitude</div>
          <input type="text" id="coordLat" placeholder="48.3809" style="width:100%;padding:7px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:#e0e0e0;font-size:12px;font-family:'DM Mono',monospace;outline:none">
        </div>
        <div style="flex:1">
          <div style="font-size:9px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Longitude</div>
          <input type="text" id="coordLng" placeholder="-89.2477" style="width:100%;padding:7px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:#e0e0e0;font-size:12px;font-family:'DM Mono',monospace;outline:none">
        </div>
      </div>
      <button onclick="goToCoords()" style="width:100%;padding:8px;border-radius:6px;border:none;background:rgba(255,255,255,0.12);color:#e0e0e0;font-size:12px;font-weight:600;cursor:pointer;font-family:'Instrument Sans',sans-serif;transition:background .15s" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.12)'">Go</button>
    </div>`;
  p.appendChild(coordDiv);
  // Auto-fill from clipboard paste
  ['coordLat','coordLng'].forEach(id=>{
    coordDiv.querySelector('#'+id).addEventListener('paste',e=>{
      setTimeout(()=>handleCoordPaste(e.target),0);
    });
  });
  // Add location items
  LOCS.forEach(l=>{
    const d=document.createElement('div');d.className='loc-item';
    d.innerHTML=`<span class="loc-icon">${l.icon}</span>${l.name}`;
    d.onclick=()=>{teleportTo(l);toggleLocPanel();};p.appendChild(d);
  });
})();

function toggleCoordInput(e){
  e.stopPropagation();
  const area=document.getElementById('coordInputArea');
  area.style.display=area.style.display==='none'?'block':'none';
}

function handleCoordPaste(target){
  const val=target.value.trim();
  // Try to parse "lat, lng" or "lat lng" format
  const parts=val.split(/[\s,]+/).filter(s=>s!=='');
  if(parts.length>=2){
    const a=parseFloat(parts[0]),b=parseFloat(parts[1]);
    if(!isNaN(a)&&!isNaN(b)){
      document.getElementById('coordLat').value=a;
      document.getElementById('coordLng').value=b;
    }
  }
}

function goToCoords(){
  const lat=parseFloat(document.getElementById('coordLat').value);
  const lng=parseFloat(document.getElementById('coordLng').value);
  if(isNaN(lat)||isNaN(lng)){return;}
  teleportTo({lat,lng,alt:300,hdg:0});
  toggleLocPanel();
}

let locOpen=false;function toggleLocPanel(){locOpen=!locOpen;document.getElementById('locPanel').classList.toggle('open',locOpen);}
let ctrlOpen=false;function toggleCtrlPanel(){ctrlOpen=!ctrlOpen;document.getElementById('ctrlPanel').classList.toggle('open',ctrlOpen);}

// ‚îÄ‚îÄ‚îÄ AIRCRAFT PHYSICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class AircraftPhysics{
  constructor(c,h=0){this.c=c;this.spd=0;this.tSpd=0;this.h=h;this.p=0;this.r=0;this.vv=0;this._ti=0;}
  update(dt,i){
    const c=this.c;
    // Drone: W=forward, S=backward/brake, no constant min speed
    const td=(i.throttle?1:0)-(i.brake?1:0);
    if(td){this.tSpd+=td*c.speedChangeRate*dt;
      this.tSpd=Math.max(0,Math.min(c.maxSpeed,this.tSpd));
    }else{
      // Decelerate to hover when no input
      this.tSpd=Cesium.Math.lerp(this.tSpd,0,0.02);
      if(Math.abs(this.tSpd)<0.5)this.tSpd=0;
    }
    const ms=c.speedChangeRate*dt;this.spd+=Math.max(-ms,Math.min(ms,this.tSpd-this.spd));
    if(Math.abs(this.spd)<0.1&&Math.abs(this.tSpd)<0.1)this.spd=0;
    // Roll ‚Äî slow build-up
    let ri=0;if(i.rollLeft||i.turnLeft)ri-=1;if(i.rollRight||i.turnRight)ri+=1;
    this.r=Cesium.Math.lerp(this.r,ri*c.maxRoll,0.04);
    // Turn ‚Äî damped, gradual yaw
    let ti=0;if(i.turnLeft||i.rollLeft)ti-=1;if(i.turnRight||i.rollRight)ti+=1;
    this._ti=Cesium.Math.lerp(this._ti||0,ti,0.04);
    this.h=Cesium.Math.zeroToTwoPi(this.h+(this._ti+this.r/c.maxRoll*0.5)*c.turnRate*dt);
    // Climb/dive ‚Äî gentle vertical response
    let ci=0;if(i.altitudeUp)ci+=1;if(i.altitudeDown)ci-=1;
    if(ci!==0){
      this.vv=Cesium.Math.lerp(this.vv,ci*c.climbRate,0.03);
    }else{
      this.vv=Cesium.Math.lerp(this.vv,0,0.05);
      if(Math.abs(this.vv)<0.1)this.vv=0;
    }
    // Pitch tilt ‚Äî subtle and slow
    this.p=Cesium.Math.lerp(this.p,Cesium.Math.toRadians(15)*ci,0.03);
    return{positionDelta:new Cesium.Cartesian3(this.spd*dt,0,0),verticalDelta:this.vv*dt,
      heading:this.h,pitch:this.p,roll:this.r,speed:this.spd};
  }
}

// ‚îÄ‚îÄ‚îÄ CAR PHYSICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class CarPhysics{
  constructor(c){this.c=c;this.v=0;this.a=0;this.si=0;}
  update(dt,i,ctx){
    let r=this._ph(dt,i);r={...r,...this._st(dt,i)};
    if(ctx&&ctx.enabled!==false){const h=this._col(ctx);
      if(h){this.v=0;this.a=0;r={...r,velocity:0,speed:0,bounce:h==='front'?-(ctx.bounceDistance||0.3):(ctx.bounceDistance||0.3)};}}
    return r;
  }
  _ph(dt,i){const c=this.c;let f=0;if(i.throttle)f+=c.engineForce;
    if(i.brake)f-=this.v>0.5?c.brakeForce:c.engineForce*0.6;
    const rf=c.rollingResistance*c.vehicleMass*9.81;
    if(this.v>0)f-=rf;else if(this.v<0)f+=rf;
    f-=c.airDragCoefficient*this.v*Math.abs(this.v);
    this.a=f/c.vehicleMass;this.v+=this.a*dt;
    this.v=Math.max(-c.maxSpeed*0.5,Math.min(c.maxSpeed,this.v));
    if(!i.throttle&&!i.brake&&Math.abs(this.v)>0.1)
      this.v=this.v>0?Math.max(0,this.v-8*dt):Math.min(0,this.v+8*dt);
    return{velocity:this.v,acceleration:this.a,speed:Math.abs(this.v)};}
  _st(dt,i){const c=this.c;if(!c.wheelbase||!c.maxSteeringAngle)return{turnRate:0,frontWheelAngle:0,steeringReduction:1};
    let t=0;if(i.turnLeft)t=-1;if(i.turnRight)t=1;
    this.si+=(t-this.si)*(Math.abs(this.v)<5?0.05:0.1);
    let sr=1;const sk=Math.abs(this.v);if(sk>30)sr=Math.max(0.2,1-((sk-30)/70)*0.8);
    const fw=this.si*c.maxSteeringAngle*sr;let tr=0;
    if(Math.abs(fw)>0.001&&Math.abs(this.v)>0.1)tr=(this.v/(c.wheelbase/Math.tan(Math.abs(fw))))*Math.sign(fw);
    return{turnRate:tr,frontWheelAngle:fw,steeringReduction:sr};}
  _col(ctx){const pd=ctx.probeDistance||1,ht=ctx.heightThreshold||1;
    const tf=new Cesium.Matrix4();Cesium.Transforms.eastNorthUpToFixedFrame(ctx.position,undefined,tf);
    const lf=new Cesium.Cartesian3(Math.cos(ctx.heading),-Math.sin(ctx.heading),0);
    const wf=Cesium.Matrix4.multiplyByPointAsVector(tf,lf,new Cesium.Cartesian3());
    Cesium.Cartesian3.normalize(wf,wf);const exc=ctx.exclude||[];
    const vh=Cesium.Cartographic.fromCartesian(ctx.position).height;
    const fp=Cesium.Cartesian3.add(ctx.position,Cesium.Cartesian3.multiplyByScalar(wf,pd,new Cesium.Cartesian3()),new Cesium.Cartesian3());
    const cf=ctx.scene.clampToHeight(fp,exc);if(cf&&Cesium.Cartographic.fromCartesian(cf).height>vh+ht)return'front';
    const bp=Cesium.Cartesian3.add(ctx.position,Cesium.Cartesian3.multiplyByScalar(wf,-pd,new Cesium.Cartesian3()),new Cesium.Cartesian3());
    const cb=ctx.scene.clampToHeight(bp,exc);if(cb&&Cesium.Cartographic.fromCartesian(cb).height>vh+ht)return'back';
    return null;}
}

// ‚îÄ‚îÄ‚îÄ CAMERAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _la(s,e,f){s=Cesium.Math.zeroToTwoPi(s);e=Cesium.Math.zeroToTwoPi(e);let d=e-s;
  if(d>Math.PI)d-=Cesium.Math.TWO_PI;else if(d<-Math.PI)d+=Cesium.Math.TWO_PI;
  return Cesium.Math.zeroToTwoPi(s+d*f);}
function _ad(c,p){c=Cesium.Math.zeroToTwoPi(c);p=Cesium.Math.zeroToTwoPi(p);let d=c-p;
  if(d>Math.PI)d-=Cesium.Math.TWO_PI;else if(d<-Math.PI)d+=Cesium.Math.TWO_PI;return d;}

class FollowCamera{
  constructor(c){this.c=c;this.tH=0;this.tP=0;this.tR=0;this.cH=0;this.cP=0;this.cR=0;this.aR=0;
    this.lH=0;this.hp=new Cesium.HeadingPitchRange();this.d=80;this.baseD=80;}
  activate(v){if(!v)return;const s=v.getState();
    this.baseD=v.type==='car'?15:30;this.d=this.baseD;
    const pitchDeg=v.type==='car'?-20:-22;
    const h=s.heading+Math.PI;const p=Cesium.Math.toRadians(pitchDeg);
    this.cH=this.tH=Cesium.Math.zeroToTwoPi(h);this.cP=this.tP=p;this.cR=this.tR=0;this.aR=0;
    this.lH=Cesium.Math.zeroToTwoPi(s.heading);this.hp.heading=h;this.hp.pitch=p;this.hp.range=this.d;}
  update(dt,v){if(!v)return;const bs=v.getBoundingSphere();if(!bs)return;const s=v.getState();
    const hd=_ad(s.heading,this.lH);
    const pitchDeg=v.type==='car'?-15:-18;
    this.tH=s.heading+Math.PI/2;this.tP=s.pitch-Cesium.Math.toRadians(-pitchDeg);
    this.tR=Math.abs(s.roll)>0.01?s.roll*0.5:-hd*0.6;
    // Mouse look: apply offset when stationary, fade when moving
    if(s.speed>1.5){mouseLook.hOff=Cesium.Math.lerp(mouseLook.hOff,0,0.04);mouseLook.pOff=Cesium.Math.lerp(mouseLook.pOff,0,0.04);
      if(Math.abs(mouseLook.hOff)<0.005&&Math.abs(mouseLook.pOff)<0.005){mouseLook.hOff=0;mouseLook.pOff=0;mouseLook.active=false;}}
    this.cH=_la(this.cH,this.tH+mouseLook.hOff,0.04);this.cP=Cesium.Math.lerp(this.cP,this.tP+mouseLook.pOff,0.04);
    this.cR=Cesium.Math.lerp(this.cR,this.tR,0.04);
    // Scroll zoom
    this.d=Cesium.Math.lerp(this.d,Math.max(5,this.baseD+camZoomOff),0.08);
    this.hp.heading=this.cH;this.hp.pitch=this.cP;this.hp.range=this.d;
    // Offset target upward to push model into lower portion of screen
    const upOff=v.type==='car'?6:12;
    const enu=Cesium.Transforms.eastNorthUpToFixedFrame(bs.center);
    const upCol=Cesium.Matrix4.getColumn(enu,2,new Cesium.Cartesian4());
    const upV=new Cesium.Cartesian3(upCol.x,upCol.y,upCol.z);
    const target=Cesium.Cartesian3.add(bs.center,Cesium.Cartesian3.multiplyByScalar(upV,upOff,new Cesium.Cartesian3()),new Cesium.Cartesian3());
    this.c.lookAt(target,this.hp);
    const rd=this.cR-this.aR;if(Math.abs(rd)>0.001){this.c.twistRight(rd);this.aR=this.cR;}
    this.lH=s.heading;}
}

class FollowCloseCamera{
  constructor(c){this.c=c;this.tH=0;this.tP=0;this.tR=0;this.cH=0;this.cP=0;this.cR=0;this.aR=0;
    this.lH=0;this.hp=new Cesium.HeadingPitchRange();this.d=25;this.baseD=25;}
  activate(v){if(!v)return;const s=v.getState();
    this.baseD=v.type==='car'?8:8;this.d=this.baseD;
    const pitchDeg=v.type==='car'?-12:-15;
    const h=s.heading+Math.PI/2;const p=Cesium.Math.toRadians(pitchDeg);
    this.cH=this.tH=Cesium.Math.zeroToTwoPi(h);this.cP=this.tP=p;this.cR=this.tR=0;this.aR=0;
    this.lH=Cesium.Math.zeroToTwoPi(s.heading);this.hp.heading=h;this.hp.pitch=p;this.hp.range=this.d;}
  update(dt,v){if(!v)return;const bs=v.getBoundingSphere();if(!bs)return;const s=v.getState();
    const hd=_ad(s.heading,this.lH);
    this.tH=s.heading+Math.PI/2;this.tP=s.pitch+Cesium.Math.toRadians(-12);
    this.tR=Math.abs(s.roll)>0.01?s.roll*0.7:-hd*1.2;
    // Mouse look: apply offset when stationary, fade when moving
    if(s.speed>1.5){mouseLook.hOff=Cesium.Math.lerp(mouseLook.hOff,0,0.04);mouseLook.pOff=Cesium.Math.lerp(mouseLook.pOff,0,0.04);
      if(Math.abs(mouseLook.hOff)<0.005&&Math.abs(mouseLook.pOff)<0.005){mouseLook.hOff=0;mouseLook.pOff=0;mouseLook.active=false;}}
    this.cH=_la(this.cH,this.tH+mouseLook.hOff,0.08);this.cP=Cesium.Math.lerp(this.cP,this.tP+mouseLook.pOff,0.08);
    this.cR=Cesium.Math.lerp(this.cR,this.tR,0.08);
    // Scroll zoom
    this.d=Cesium.Math.lerp(this.d,Math.max(3,this.baseD+camZoomOff),0.08);
    this.hp.heading=this.cH;this.hp.pitch=this.cP;this.hp.range=this.d;
    // Offset target upward to push model into lower portion of screen
    const upOff=v.type==='car'?3:5;
    const enu=Cesium.Transforms.eastNorthUpToFixedFrame(bs.center);
    const upCol=Cesium.Matrix4.getColumn(enu,2,new Cesium.Cartesian4());
    const upV=new Cesium.Cartesian3(upCol.x,upCol.y,upCol.z);
    const target=Cesium.Cartesian3.add(bs.center,Cesium.Cartesian3.multiplyByScalar(upV,upOff,new Cesium.Cartesian3()),new Cesium.Cartesian3());
    this.c.lookAt(target,this.hp);
    const rd=this.cR-this.aR;if(Math.abs(rd)>0.001){this.c.twistRight(rd);this.aR=this.cR;}
    this.lH=s.heading;}
}

// ‚îÄ‚îÄ‚îÄ VEHICLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Vehicle{
  constructor(type,prim,pos,hdg,phys,scene){
    this.type=type;this.prim=prim;this.pos=Cesium.Cartesian3.clone(pos);
    this.hpr=new Cesium.HeadingPitchRoll(hdg,0,0);this.phys=phys;this.scene=scene;
    this.vel=0;this.spd=0;this.crashed=false;this.ready=false;
    this.mho=0;
    this.cf=0;this.cH=hdg;
    this.inp={throttle:false,brake:false,turnLeft:false,turnRight:false,
      altitudeUp:false,altitudeDown:false,rollLeft:false,rollRight:false};
  }
  getState(){return{position:Cesium.Cartesian3.clone(this.pos),heading:this.hpr.heading,
    pitch:this.hpr.pitch,roll:this.hpr.roll,velocity:this.vel,speed:this.spd};}
  setState(s){this.pos=Cesium.Cartesian3.clone(s.position);this.hpr.heading=s.heading;
    this.hpr.pitch=s.pitch;this.hpr.roll=s.roll;this.vel=s.velocity;this.spd=s.speed;
    if(this.type==='car')this.cH=s.heading;this._mm();}
  getBoundingSphere(){if(!this.prim||!this.ready)return null;try{return this.prim.boundingSphere;}catch(e){return null;}}
  isReady(){return this.ready&&!!this.prim;}
  setInput(i){Object.assign(this.inp,i);}
  update(dt){if(!this.prim||this.crashed||!this.ready)return;this.type==='aircraft'?this._air(dt):this._car(dt);}

  _air(dt){
    const r=this.phys.update(dt,this.inp);
    this.hpr.heading=r.heading;this.hpr.pitch=r.pitch;this.hpr.roll=r.roll;
    const tf=Cesium.Transforms.headingPitchRollToFixedFrame(this.pos,this.hpr,Cesium.Ellipsoid.WGS84);
    const wf=Cesium.Matrix4.multiplyByPoint(tf,r.positionDelta,new Cesium.Cartesian3());
    const fwd=Cesium.Cartesian3.subtract(wf,this.pos,new Cesium.Cartesian3());
    const enu=Cesium.Transforms.eastNorthUpToFixedFrame(this.pos);
    const uc=Cesium.Matrix4.getColumn(enu,2,new Cesium.Cartesian4());
    const up=Cesium.Cartesian3.fromCartesian4(uc);
    const vd=Cesium.Cartesian3.multiplyByScalar(up,r.verticalDelta,new Cesium.Cartesian3());
    this.pos=Cesium.Cartesian3.add(this.pos,Cesium.Cartesian3.add(fwd,vd,new Cesium.Cartesian3()),this.pos);
    this.vel=r.speed;this.spd=Math.abs(r.speed);
    this.cf++;if(this.cf>=4){this.cf=0;this._colCheck();}
    this._mm();
  }

  _colCheck(){
    if(!this.scene)return;
    try{
      const ch=Cesium.Cartographic.fromCartesian(this.pos).height;
      const g=this.scene.clampToHeight(this.pos,[this.prim]);
      if(g){
        const gh=Cesium.Cartographic.fromCartesian(g).height;
        const minClearance=3;
        if(ch<=gh+minClearance){this._bounce(gh+minClearance+5);return;}
      }
      const tf=Cesium.Transforms.eastNorthUpToFixedFrame(this.pos);
      const lf=new Cesium.Cartesian3(Math.cos(this.hpr.heading),-Math.sin(this.hpr.heading),0);
      const wf=Cesium.Matrix4.multiplyByPointAsVector(tf,lf,new Cesium.Cartesian3());
      Cesium.Cartesian3.normalize(wf,wf);
      const pr=Cesium.Cartesian3.add(this.pos,Cesium.Cartesian3.multiplyByScalar(wf,2,new Cesium.Cartesian3()),new Cesium.Cartesian3());
      const a=this.scene.clampToHeight(pr,[this.prim]);
      if(a&&Cesium.Cartographic.fromCartesian(a).height>ch+1)this._bounce(ch+8);
    }catch(e){}
  }

  _bounce(targetHeight){
    // Push drone up to target height and kill downward velocity
    const cart=Cesium.Cartographic.fromCartesian(this.pos);
    this.pos=Cesium.Cartesian3.fromRadians(cart.longitude,cart.latitude,targetHeight);
    if(this.phys){
      this.phys.vv=Math.max(this.phys.vv,3); // gentle upward nudge
      this.phys.spd*=0.5; // slow down on bounce
      this.phys.tSpd*=0.5;
    }
    this._mm();
  }

  _crash(){this.crashed=true;this.vel=0;this.spd=0;document.getElementById('crashScreen').classList.add('active');}

  _car(dt){
    const pr=this.phys.update(dt,this.inp,{scene:this.scene,position:this.pos,heading:this.cH,
      exclude:[this.prim],enabled:false,probeDistance:1,bounceDistance:0.3,heightThreshold:1});
    this.vel=pr.velocity;this.spd=pr.speed;
    if(Math.abs(this.vel)>0.1){this.cH=Cesium.Math.zeroToTwoPi(this.cH+pr.turnRate*dt);}
    this.hpr.heading=this.cH;
    this.hpr.pitch=Cesium.Math.lerp(this.hpr.pitch,0,0.05);
    this.hpr.roll=Cesium.Math.lerp(this.hpr.roll,0,0.05);
    const h2=new Cesium.HeadingPitchRoll(this.cH,this.hpr.pitch,this.hpr.roll);
    const mm=Cesium.Transforms.headingPitchRollToFixedFrame(this.pos,h2,Cesium.Ellipsoid.WGS84);
    const sv=Cesium.Cartesian3.multiplyByScalar(Cesium.Cartesian3.UNIT_X,this.vel*0.01,new Cesium.Cartesian3());
    this.pos=Cesium.Matrix4.multiplyByPoint(mm,sv,this.pos);
    if(typeof pr.bounce==='number'&&pr.bounce!==0){
      const tf2=Cesium.Transforms.eastNorthUpToFixedFrame(this.pos);
      const lf2=new Cesium.Cartesian3(Math.cos(this.cH),-Math.sin(this.cH),0);
      const wf2=Cesium.Matrix4.multiplyByPointAsVector(tf2,lf2,new Cesium.Cartesian3());
      Cesium.Cartesian3.normalize(wf2,wf2);
      this.pos=Cesium.Cartesian3.add(this.pos,Cesium.Cartesian3.multiplyByScalar(wf2,pr.bounce,new Cesium.Cartesian3()),this.pos);
    }
    if(this.scene){try{const cl=this.scene.clampToHeight(this.pos,[this.prim]);if(cl)this.pos=cl;}catch(e){}}
    this._mm();
  }

  _mm(){if(!this.prim)return;const h=new Cesium.HeadingPitchRoll(this.hpr.heading+this.mho,this.hpr.pitch,this.hpr.roll);
    Cesium.Transforms.headingPitchRollToFixedFrame(this.pos,h,Cesium.Ellipsoid.WGS84,undefined,this.prim.modelMatrix);}
  destroy(prims){if(this.prim){try{prims.remove(this.prim);}catch(e){}this.prim=null;}}
}

// ‚îÄ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let viewer,sc,av,cams={},act='follow',lt=0,running=false;
let lastSpawn={lng:-89.2477,lat:48.3809,alt:300,hdg:0};
const inp={throttle:false,brake:false,turnLeft:false,turnRight:false,
  altitudeUp:false,altitudeDown:false,rollLeft:false,rollRight:false};
const KM={'KeyW':'throttle','KeyS':'brake','KeyA':'turnLeft','KeyD':'turnRight',
  'ArrowUp':'altitudeUp','ArrowDown':'altitudeDown','ArrowLeft':'turnLeft','ArrowRight':'turnRight',
  'KeyQ':'rollLeft','KeyE':'rollRight'};

document.addEventListener('keydown',e=>{const a=KM[e.code];
  if(a){e.preventDefault();inp[a]=true;if(av)av.setInput({[a]:true});}
  if(e.code==='KeyC')switchCam();if(e.code==='KeyM')toggleVeh();if(e.code==='KeyR')restart();if(e.code==='KeyV')toggleModelVis();if(e.code==='KeyP')takeScreenshot();});
document.addEventListener('keyup',e=>{const a=KM[e.code];if(a){inp[a]=false;if(av)av.setInput({[a]:false});}});
document.addEventListener('contextmenu',e=>e.preventDefault());

// ‚îÄ‚îÄ‚îÄ MOUSE LOOK & SCROLL ZOOM ‚îÄ‚îÄ‚îÄ
let mouseLook={active:false,hOff:0,pOff:0,lastX:0,lastY:0,down:false};
let camZoomOff=0; // added to camera distance

function initMouseControls(){
  // Use document-level events to avoid Cesium intercepting them
  const canvas=viewer.canvas;
  canvas.addEventListener('pointerdown',e=>{
    if(e.button===0&&running){
      mouseLook.down=true;mouseLook.lastX=e.clientX;mouseLook.lastY=e.clientY;
      e.preventDefault();
    }
  });
  document.addEventListener('pointerup',e=>{if(e.button===0)mouseLook.down=false;});
  document.addEventListener('pointermove',e=>{
    if(!mouseLook.down||!av||!running)return;
    if(av.spd>1.5)return;
    const dx=e.clientX-mouseLook.lastX;
    const dy=e.clientY-mouseLook.lastY;
    mouseLook.lastX=e.clientX;mouseLook.lastY=e.clientY;
    mouseLook.hOff-=dx*0.005;
    mouseLook.pOff-=dy*0.004;
    mouseLook.pOff=Math.max(-1.2,Math.min(0.3,mouseLook.pOff));
    mouseLook.active=true;
  });
  canvas.addEventListener('wheel',e=>{
    e.preventDefault();
    camZoomOff+=e.deltaY*0.03;
    camZoomOff=Math.max(-20,Math.min(80,camZoomOff));
  },{passive:false});
}

function resetCameraState(){
  mouseLook.active=false;mouseLook.hOff=0;mouseLook.pOff=0;mouseLook.down=false;
  camZoomOff=0;
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initGame(cesiumToken,googleKey){
  try{
    if(cesiumToken){Cesium.Ion.defaultAccessToken=cesiumToken;console.log('‚úÖ Cesium Ion token set');}
    if(googleKey){Cesium.GoogleMaps.defaultApiKey=googleKey;console.log('‚úÖ Google Maps API key set');}
    setLT('Creating viewer...');

    viewer=new Cesium.Viewer('cesiumContainer',{
      timeline:false,animation:false,baseLayer:false,baseLayerPicker:false,
      geocoder:false,shadows:false,msaaSamples:4,homeButton:false,
      sceneModePicker:false,navigationHelpButton:false,fullscreenButton:false,
      vrButton:false,infoBox:false,selectionIndicator:false,
      creditContainer:document.createElement('div'),
      contextOptions:{webgl:{preserveDrawingBuffer:true}}});

    sc=viewer.scene;sc.globe.show=false;
    const scc=sc.screenSpaceCameraController;
    scc.enableRotate=false;scc.enableZoom=false;scc.enableLook=false;scc.enableTilt=false;
    scc.enableTranslate=false;scc.enableInputs=false;

    // Init mouse controls now that canvas exists
    initMouseControls();

    const bl=sc.postProcessStages.bloom;bl.enabled=true;bl.uniforms.brightness=-0.5;
    bl.uniforms.stepSize=1;bl.uniforms.sigma=3;bl.uniforms.delta=1.5;
    sc.highDynamicRange=true;sc.postProcessStages.exposure=1.5;sc.postProcessStages.fxaa.enabled=true;
    Cesium.RequestScheduler.requestsByServer["tile.googleapis.com:443"]=18;

    setLT('Loading 3D terrain...');
    let terrainOk=false;

    // Attempt 1: Google Photorealistic 3D Tiles
    try{
      let ts;
      if(googleKey){
        // Direct Google Maps API key
        console.log('üì° Using Google Maps API key directly...');
        Cesium.GoogleMaps.defaultApiKey=googleKey;
        ts=await Cesium.createGooglePhotorealistic3DTileset();
      }else{
        // Via Cesium Ion (default behavior since 1.110)
        console.log('üì° Loading Google 3D Tiles via Cesium Ion...');
        ts=await Cesium.createGooglePhotorealistic3DTileset();
      }
      sc.primitives.add(ts);
      ts.maximumScreenSpaceError=32;
      ts.dynamicScreenSpaceErrorFactor=32;
      terrainOk=true;
      console.log('‚úÖ Google Photorealistic 3D Tiles loaded');
    }catch(err){
      console.warn('‚ö†Ô∏è Google 3D Tiles failed:', err.message||err);
    }

    // Attempt 2: Cesium World Terrain with imagery
    if(!terrainOk){
      try{
        setLT('Falling back to Cesium World Terrain...');
        sc.globe.show=true;
        viewer.terrainProvider=await Cesium.createWorldTerrainAsync({requestVertexNormals:true});
        try{
          const imgProvider=await Cesium.createWorldImageryAsync();
          viewer.imageryLayers.addImageryProvider(imgProvider);
        }catch(e){console.warn('Imagery layer failed:',e.message);}
        terrainOk=true;
        console.log('‚úÖ Cesium World Terrain loaded');
      }catch(err2){console.warn('‚ö†Ô∏è World Terrain also failed:',err2.message);}
    }

    if(!terrainOk){
      backToToken('Could not load any terrain. Please check your token is valid and has access to Cesium assets.');
      return;
    }

    cams.follow=new FollowCamera(viewer.camera);
    cams.followClose=new FollowCloseCamera(viewer.camera);

    setLT('Flying to spawn...');
    const sh=sc.postRender.addEventListener(()=>{viewer.camera.rotateRight(Cesium.Math.toRadians(0.1));});
    await delay(2500);sh();

    const sp=Cesium.Cartesian3.fromDegrees(-89.2477,48.3809,300);
    await new Promise(r=>{viewer.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(-89.2477,48.3809,500),duration:3,complete:r});});
    await new Promise(r=>{viewer.camera.flyTo({destination:sp,
      orientation:{heading:Cesium.Math.toRadians(230),pitch:Cesium.Math.toRadians(-15),roll:0},duration:1,complete:r});});

    setLT('Spawning aircraft...');
    await spawnAir(sp,0);

    lt=performance.now();sc.preUpdate.addEventListener(loop);running=true;

    document.getElementById('loadingOverlay').classList.remove('active');
    ['hud','vehicleBadge','controlsHelp','locationSelector','topLeftBar'].forEach(id=>document.getElementById(id).classList.add('visible'));
    console.log('üéÆ Ready! Use WASD to fly.');
  }catch(err){console.error('‚ùå Init failed:',err);backToToken('Init failed: '+err.message);}
}

function delay(ms){return new Promise(r=>setTimeout(r,ms));}

// ‚îÄ‚îÄ‚îÄ SPAWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function spawnAir(pos,hdg){
  if(av)av.destroy(sc.primitives);
  const p=pos||Cesium.Cartesian3.fromDegrees(-89.2477,48.3809,300);
  const ph=new AircraftPhysics({minSpeed:0,maxSpeed:800,speedChangeRate:15,
    turnRate:Cesium.Math.toRadians(25),climbRate:12,gravity:0,
    rollRate:Cesium.Math.toRadians(30),maxRoll:Cesium.Math.toRadians(20),
    pitchRate:Cesium.Math.toRadians(30),maxPitch:Cesium.Math.toRadians(30)},hdg||0);
  const hp=new Cesium.HeadingPitchRoll(hdg||0,0,0);
  const droneUrl='https://raw.githubusercontent.com/arifullahjan/ARFoo/master/drone.glb';
  // Fallback URL if ARFoo is down: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb'
  try{
    const pr=sc.primitives.add(await Cesium.Model.fromGltfAsync({
      url:droneUrl,scale:9.0,
      modelMatrix:Cesium.Transforms.headingPitchRollToFixedFrame(p,hp,Cesium.Ellipsoid.WGS84)}));
    av=new Vehicle('aircraft',pr,p,hdg||0,ph,sc);
    pr.readyEvent.addEventListener(()=>{
      av.ready=true;cams[act].activate(av);
    });
    document.getElementById('badgeDrone').style.opacity='1';document.getElementById('badgeCar').style.opacity='0.3';
  }catch(e){console.error('Drone model load failed:',e);}
}

async function spawnCar(pos,hdg){
  if(av)av.destroy(sc.primitives);
  const p=pos||Cesium.Cartesian3.fromDegrees(-89.2477,48.3809,100);
  const ph=new CarPhysics({vehicleMass:2400,engineForce:80000,brakeForce:120000,
    rollingResistance:0.15,airDragCoefficient:2.5,maxSpeed:120,
    wheelbase:8,maxSteeringAngle:Cesium.Math.toRadians(15)});
  const hp=new Cesium.HeadingPitchRoll(hdg||0,0,0);
  try{
    const resource=await Cesium.IonResource.fromAssetId(2537982);
    const pr=sc.primitives.add(await Cesium.Model.fromGltfAsync({
      url:resource,scale:0.75,
      modelMatrix:Cesium.Transforms.headingPitchRollToFixedFrame(p,hp,Cesium.Ellipsoid.WGS84)}));
    av=new Vehicle('car',pr,p,hdg||0,ph,sc);
    av.mho=0;
    pr.readyEvent.addEventListener(()=>{av.ready=true;cams[act].activate(av);});
    document.getElementById('badgeDrone').style.opacity='0.3';document.getElementById('badgeCar').style.opacity='1';
  }catch(e){
    console.warn('Ion model failed, trying GroundVehicle from GitHub...',e.message);
    const url='https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/GroundVehicle/GroundVehicle.glb';
    const pr=sc.primitives.add(await Cesium.Model.fromGltfAsync({
      url:url,scale:0.75,
      modelMatrix:Cesium.Transforms.headingPitchRollToFixedFrame(p,hp,Cesium.Ellipsoid.WGS84)}));
    av=new Vehicle('car',pr,p,hdg||0,ph,sc);
    av.mho=0;
    pr.readyEvent.addEventListener(()=>{av.ready=true;cams[act].activate(av);});
    document.getElementById('badgeDrone').style.opacity='0.3';document.getElementById('badgeCar').style.opacity='1';
  }
}

// ‚îÄ‚îÄ‚îÄ LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loop(){if(!running||!av||!av.isReady())return;const n=performance.now();const dt=Math.min((n-lt)/1000,1/30);lt=n;
  av.setInput(inp);av.update(dt);const c=cams[act];if(c&&av.getBoundingSphere())c.update(dt,av);hudUpdate();}

function hudUpdate(){if(!av)return;const s=av.getState();
  document.getElementById('hudSpeed').textContent=Math.round(s.speed);
  try{const c=Cesium.Cartographic.fromCartesian(s.position);
    document.getElementById('hudAlt').textContent=Math.round(c.height)+' m';
    document.getElementById('hudHdg').textContent=Math.round(Cesium.Math.toDegrees(s.heading))+'¬∞';
    const lat=Cesium.Math.toDegrees(c.latitude);
    const lng=Cesium.Math.toDegrees(c.longitude);
    document.getElementById('gpsText').textContent=lat.toFixed(5)+', '+lng.toFixed(5);
  }catch(e){}}

function switchCam(){const t=['follow','followClose'];act=t[(t.indexOf(act)+1)%t.length];
  cams[act].activate(av);document.getElementById('hudCam').textContent=act==='follow'?'Follow':'Close';}

async function toggleVeh(){if(!av)return;try{const s=av.getState();
  if(av.type==='aircraft'){
    await spawnCar(s.position,s.heading);
  }else{
    // When switching to aircraft from ground, boost altitude to 200m above current position
    const cart=Cesium.Cartographic.fromCartesian(s.position);
    const boostedPos=Cesium.Cartesian3.fromRadians(cart.longitude,cart.latitude,cart.height+200);
    await spawnAir(boostedPos,s.heading);
  }
  }catch(e){console.error('Vehicle toggle failed:',e);}}

let modelHidden=false;
function toggleModelVis(){
  if(!av||!av.prim)return;
  modelHidden=!modelHidden;
  av.prim.show=!modelHidden;
  document.getElementById('eyeToggle').style.opacity=modelHidden?'0.3':'1';
}

function copyGPS(){
  const t=document.getElementById('gpsText').textContent;
  navigator.clipboard.writeText(t).then(()=>{
    const el=document.getElementById('gpsCopied');el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),1500);
  }).catch(()=>{});
}

function takeScreenshot(){
  if(!viewer||!sc)return;
  // Get current coordinates
  let coordStr='unknown';
  let lat='',lng='';
  if(av){
    try{
      const c=Cesium.Cartographic.fromCartesian(av.pos);
      lat=Cesium.Math.toDegrees(c.latitude).toFixed(5);
      lng=Cesium.Math.toDegrees(c.longitude).toFixed(5);
      coordStr=lat+', '+lng;
    }catch(e){}
  }
  // Hide all HUD elements and vehicle model
  const hideEls=['hud','vehicleBadge','controlsHelp','locationSelector','topLeftBar'];
  hideEls.forEach(id=>document.getElementById(id).style.visibility='hidden');
  const wasModelHidden=modelHidden;
  if(av&&av.prim&&!modelHidden)av.prim.show=false;
  // Flash effect
  const flash=document.getElementById('flashOverlay');
  flash.style.transition='none';flash.style.opacity='0.6';
  // Wait a frame for HUD to hide, then capture
  requestAnimationFrame(()=>{
    sc.render();
    const srcCanvas=sc.canvas;
    try{
      // Create a new canvas to stamp coordinates
      const outCanvas=document.createElement('canvas');
      outCanvas.width=srcCanvas.width;outCanvas.height=srcCanvas.height;
      const ctx=outCanvas.getContext('2d');
      ctx.drawImage(srcCanvas,0,0);
      // Stamp coordinates in top-left with small font
      const fontSize=Math.max(12,Math.round(srcCanvas.height*0.015));
      ctx.font=fontSize+'px "DM Mono", monospace';
      ctx.fillStyle='rgba(255,255,255,0.7)';
      ctx.shadowColor='rgba(0,0,0,0.8)';ctx.shadowBlur=4;ctx.shadowOffsetX=1;ctx.shadowOffsetY=1;
      ctx.fillText(coordStr,fontSize*0.8,fontSize*1.6);
      outCanvas.toBlob(blob=>{
        if(!blob)return;
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        const ts=new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
        const safeCoord=(lat+'_'+lng).replace(/[^0-9.\-_]/g,'');
        a.download='GEExplorer_'+safeCoord+'_'+ts+'.png';
        document.body.appendChild(a);a.click();document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },'image/png');
    }catch(e){console.error('Screenshot failed:',e);}
    // Restore HUD and model
    hideEls.forEach(id=>document.getElementById(id).style.visibility='');
    if(av&&av.prim&&!wasModelHidden)av.prim.show=true;
    // Fade out flash
    setTimeout(()=>{flash.style.transition='opacity 0.3s';flash.style.opacity='0';},50);
  });
}

function restart(){document.getElementById('crashScreen').classList.remove('active');if(!av)return;
  const sp=Cesium.Cartesian3.fromDegrees(lastSpawn.lng,lastSpawn.lat,lastSpawn.alt);av.crashed=false;
  const hdg=Cesium.Math.toRadians(lastSpawn.hdg||0);
  resetCameraState();
  av.setState({position:sp,heading:hdg,pitch:0,roll:0,velocity:0,speed:0});
  if(av.phys){if(av.phys.spd!==undefined){av.phys.spd=av.phys.c.minSpeed;av.phys.tSpd=av.phys.c.minSpeed;av.phys.vv=0;av.phys.h=hdg;}
    if(av.phys.v!==undefined){av.phys.v=0;av.phys.si=0;}}
  cams[act].activate(av);}

function teleportTo(l){if(!av)return;const p=Cesium.Cartesian3.fromDegrees(l.lng,l.lat,l.alt);
  lastSpawn={lng:l.lng,lat:l.lat,alt:l.alt,hdg:l.hdg||0};
  av.crashed=false;document.getElementById('crashScreen').classList.remove('active');
  resetCameraState();
  av.setState({position:p,heading:Cesium.Math.toRadians(l.hdg||0),pitch:0,roll:0,velocity:0,speed:0});
  if(av.phys){if(av.phys.spd!==undefined){av.phys.spd=av.phys.c.minSpeed;av.phys.tSpd=av.phys.c.minSpeed;av.phys.vv=0;av.phys.h=Cesium.Math.toRadians(l.hdg||0);}
    if(av.phys.v!==undefined){av.phys.v=0;av.phys.si=0;}}
  cams[act].activate(av);}

</script>
</body>
</html>
